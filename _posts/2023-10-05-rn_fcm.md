---
layout: post
title: "[REACT NATIVE & FCM] Firebase Cloud Messagingì„ í™œìš©í•´ React nativeì—ì„œ ì•Œë¦¼ ë³´ë‚´ê¸°"
categories: [dev]
---

ë˜ë„ë¡ì´ë©´ íŒŒì´ì–´ë² ì´ìŠ¤ ê°™ì€ í¸í•œ íˆ´ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì§ì ‘ êµ¬í˜„í•˜ëŠ” ê²ƒì„ ì„ í˜¸í•˜ì˜€ìœ¼ë‚˜ ì•Œë¦¼ ê¸°ëŠ¥ì€ ëŒ€ì²´ë¡œ íŒŒì´ì–´ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ì–‘..

í”„ë¡œì íŠ¸ ê¸°í•œì´ ì–¼ë§ˆ ë‚¨ì§€ ì•Šì€ ìƒí™©ì´ë¼ ë ˆí¼ëŸ°ìŠ¤ê°€ ë§ì€ FCM(Firebase Cloud Messaging)ì„ ì„ íƒí•  ìˆ˜ ë°–ì— ì—†ì—ˆë‹¤.

- [íŒŒì´ì–´ë² ì´ìŠ¤](https://firebase.google.com/)ì— ì ‘ì†í•˜ì—¬ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•œë‹¤.

  êµ¬ê¸€ ì• ë„ë¦¬í‹±ìŠ¤ëŠ” ì–´ì°¨í”¼ ë“±ë¡í•´ì•¼ í•˜ë¯€ë¡œ ë¯¸ë¦¬ í•´ë‘”ë‹¤.

<img src='../attachment/231005/fcm_createproject01.PNG'>
<img src='../attachment/231005/fcm_createproject02.PNG'>
<img src='../attachment/231005/fcm_createproject03.PNG'>
<img src='../attachment/231005/fcm_createproject04.PNG'>

- í”„ë¡œì íŠ¸ì— android Appì„ ì¶”ê°€í•œë‹¤.

  Android íŒ¨í‚¤ì§€ ì´ë¦„ì—ëŠ” ì²˜ìŒ RN í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•  ë•Œ ì¼ë˜ í´ë” ì´ë¦„ ì•ì— com.ì„ ë¶™ì´ë©´ ëœë‹¤.

  `npx react-native init newapp` ìœ¼ë¡œ ë§Œë“  ê²½ìš° `com.newapp`

  ë˜ëŠ” app.jsonì—ì„œ ì´ë¦„ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

  í•˜ë‹¨ ì„ íƒì‚¬í•­ì€ í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

<img src='../attachment/231005/fcm_addandroidapp01.PNG'>
<img src='../attachment/231005/fcm_addandroidapp02.PNG'>

- ë‚˜ì˜¤ëŠ” íŒŒì¼ì„ ì•ˆë‚´ëœ ìœ„ì¹˜ì— ì €ì¥í•œë‹¤. ì´ë¯¸ ìˆì„ ê±´ë° ë®ì–´ ì”Œìš°ë©´ ëœë‹¤.

<img src='../attachment/231005/fcm_addandroidapp03.PNG'>

- ê·¸ ë‹¤ìŒ ì•ˆë‚´ëŒ€ë¡œ í–ˆë”ë‹ˆ ì˜ ì•ˆë˜ì—ˆë‹¤.
<img src='../attachment/231005/fcm_addandroidapp04.PNG'>

**RN í”„ë¡œì íŠ¸ í´ë” ì•ˆì— ìˆëŠ” android í´ë” ì•ˆì— build.gradle íŒŒì¼ì´ ë‘ ê°œ ìˆë‹¤.**

**í•˜ë‚˜ëŠ” android í´ë” ê¸°ì¤€ ìµœìƒë‹¨, í•˜ë‚˜ëŠ” android/app/src ë°‘ì— ìˆë‹¤.**

**ì „ìê°€ í”„ë¡œì íŠ¸ ìˆ˜ì¤€, í›„ìê°€ ì•± ìˆ˜ì¤€ì´ë‹¤.**

<img src='../attachment/231005/rnprojectandroiddirectory.PNG'>

ë‚´ê°€ ìˆ˜ì •í•œ build.gradle

- í”„ë¡œì íŠ¸ ìˆ˜ì¤€

```java
// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
    ext {
        buildToolsVersion = "33.0.0"
        minSdkVersion = 21
        compileSdkVersion = 33
        targetSdkVersion = 33

        // We use NDK 23 which has both M1 support and is the side-by-side NDK version from AGP.
        ndkVersion = "23.1.7779620"
    }
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath("com.android.tools.build:gradle")
        classpath("com.facebook.react:react-native-gradle-plugin")
        classpath 'com.google.gms:google-services:4.3.15' // ì¶”ê°€
    }
}
```

- ì•± ìˆ˜ì¤€

```java
apply plugin: "com.android.application"
apply plugin: "com.facebook.react"

/* ì£¼ì„... */

react {
  /* ì£¼ì„... */
}

/* ì£¼ì„... */

def enableProguardInReleaseBuilds = false

/* ì£¼ì„... */

def jscFlavor = 'org.webkit:android-jsc:+'

android {
    ndkVersion rootProject.ext.ndkVersion

    compileSdkVersion rootProject.ext.compileSdkVersion

    namespace "com.client"
    defaultConfig {
        applicationId "com.client"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"
    }
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
    }
    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            /* ì£¼ì„... */
            signingConfig signingConfigs.debug
            minifyEnabled enableProguardInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }
}

dependencies {
    /* ì£¼ì„... */
    implementation("com.facebook.react:react-android")

    debugImplementation("com.facebook.flipper:flipper:${FLIPPER_VERSION}")
    debugImplementation("com.facebook.flipper:flipper-network-plugin:${FLIPPER_VERSION}") {
        exclude group:'com.squareup.okhttp3', module:'okhttp'
    }

    debugImplementation("com.facebook.flipper:flipper-fresco-plugin:${FLIPPER_VERSION}")
    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation jscFlavor
    }

    // ì¶”ê°€!!!
    // Import the Firebase BoM
    implementation(platform("com.google.firebase:firebase-bom:32.3.1"))
    implementation 'com.google.firebase:firebase-messaging'
    implementation 'com.google.firebase:firebase-analytics'
    
    // ìœ„ ì„¸ ì¤„ì„ ì“°ê±°ë‚˜ ì•„ë˜ ë‘ ì¤„ì„ ì“°ê±°ë‚˜
    // Add the dependencies for the Firebase Cloud Messaging and Analytics libraries
    // When NOT using the BoM, you must specify versions in Firebase library dependencies ì¤‘ìš”í•œ ì„¤ëª…!
    // implementation 'com.google.firebase:firebase-messaging:23.1.2'
    // implementation 'com.google.firebase:firebase-analytics:21.3.0'
}

apply from: file("../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle"); applyNativeModulesAppBuildGradle(project)
apply from: "../../node_modules/react-native-vector-icons/fonts.gradle"
apply plugin: 'com.google.gms.google-services' // ì¶”ê°€
apply plugin: 'com.android.application' // ì¶”ê°€
```

## ë”± ì´ê²ƒë§Œ í•´ì£¼ë©´ ì˜¤ì¼€ì´!!!

ì´ì œ android í´ë”ë¥¼ ê±´ë“œë¦´ ì¼ì€ ì—†ë‹¤!!

ë¬¸ì„œì— ë³´ë©´ android studio í”„ë¡œì íŠ¸ì˜ java ê¸°ì¤€ ì½”ë“œê°€ ë§ì€ë° ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë‹ˆ ë­ë‹ˆ ê±´ë“œë¦¬ì§€ ì•Šì•„ë„ ëœë‹¤. ê±´ë“œë¦¬ë‹¤ê°€ ì˜¤íˆë ¤ ë§ê°€ì¡Œë‹¤!

ì´ì œë¶€í„° ì‹ ê²½ ì“¸ ë¬¸ì„œëŠ” [ReactNativeFirebase](https://rnfirebase.io/)! ë¬¸ì„œê°€ ì•„ì£¼ ì¹œì ˆí•´ì„œ ê·¸ëŒ€ë¡œ ë”°ë¼í•˜ë©´ ì˜ ëœë‹¤.

[ì´ ë¬¸ì„œ](https://rnfirebase.io/)ì™€ [ì´ ë¬¸ì„œ](https://rnfirebase.io/messaging/usage)ë¥¼ ì™”ë‹¤ë¦¬ ê°”ë‹¤ë¦¬ í•˜ë©´ì„œ ì°¸ê³ í•œë‹¤.

- í•„ìš”í•œ ëª¨ë“ˆì„ RN í”„ë¡œì íŠ¸ì— ì„¤ì¹˜ ìš°ë¦¬ëŠ” cloud messagingë„ ì‚¬ìš©í•  ê±°ë‹ˆê¹Œ ë‘ ê°œ ì„¤ì¹˜

<img src='../attachment/231005/rnfirebase01.PNG'>
<img src='../attachment/231005/rnfirebase02.PNG'>

```
npm install --save @react-native-firebase/app
npm install --save @react-native-firebase/messaging
```

- ì•„ë˜ ë‘ ê°€ì§€ë¥¼ ì°¸ê³ í•˜ì—¬ ì½”ë“œ ì‘ì„± forground messageëŠ” ì•±ì´ ì¼œì ¸ ìˆì„ ë•Œ ì•Œë¦¼, background & quit messageëŠ” ì•±ì´ êº¼ì ¸ìˆê±°ë‚˜ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¼ ë•Œ ì•Œë¦¼ì— ëŒ€í•œ ì„¤ì •ì´ë‹¤.

- forground ì½”ë“œëŠ” App.js íŒŒì¼ì—ì„œ App í•¨ìˆ˜ì˜ ì‹œì‘ì ì—, backgound & quit ì½”ë“œëŠ” Index.js íŒŒì¼ì—ì„œ AppRegistry.registerComponent ìœ„ì— ì‘ì„±í•œë‹¤.
<img src='../attachment/231005/rnfirebase03.PNG'>
<img src='../attachment/231005/rnfirebase04.PNG'>

- ì•ˆë“œë¡œì´ë“œ APIê°€ 33 ì´ìƒì¸ ê²½ìš°ì—ëŠ” ì•Œë¦¼ì— ëŒ€í•œ ê¶Œí•œ í—ˆìš©ì´ í•„ìš”í•˜ë‹¤.

  ì½”ë“œë¥¼ App.jsì˜ App í•¨ìˆ˜ ì‹œì‘ ì ì— ì¶”ê°€í•œë‹¤.

<img src='../attachment/231005/rnfirebase05.PNG'>

```js
// App.js
...
import messaging from '@react-native-firebase/messaging';

export default function App() {
  PermissionsAndroid.request(PermissionsAndroid.PERMISSIONS.POST_NOTIFICATIONS);
 
  useEffect(() => {
    getFcmToken();
    const unsubscribe = messaging().onMessage(async remoteMessage => {
      console.log('[Remote Message] ', JSON.stringify(remoteMessage));
      // Alert.alert('A new FCM message arrived!', JSON.stringify(remoteMessage));
    });
    return unsubscribe;
  }, []);

  return ( ...
```

```js
// index.js
...
import messaging from '@react-native-firebase/messaging';

messaging().setBackgroundMessageHandler(async (remoteMessage) => {
  console.log('Message handled in the background!', remoteMessage);
});

AppRegistry.registerComponent(appName, () => App);
```

FCMì€ ì—°ê²°ëœ ê°ê°ì˜ ê¸°ê¸°ë§ˆë‹¤ tokenì´ ìƒì„±ëœë‹¤. ì—ë®¬ë ˆì´í„°ì˜ í† í°ì„ ì•Œì•„ì™€ì„œ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì„ ë³´ë‚´ë³´ì.

í† í°ì„ ì•Œì•„ì˜¤ëŠ” ì½”ë“œëŠ” App.js íŒŒì¼ì— ì¶”ê°€í•œë‹¤.

```js
// App.js
...
import messaging from '@react-native-firebase/messaging';

const Stack = createNativeStackNavigator();

export default function App() {
  PermissionsAndroid.request(PermissionsAndroid.PERMISSIONS.POST_NOTIFICATIONS);

  // ì¶”ê°€!
  const getFcmToken = async () => {
    const fcmToken = await messaging().getToken();
    console.log('[FCM Token] ', fcmToken);
  };
 
  useEffect(() => {
    getFcmToken();
    const unsubscribe = messaging().onMessage(async remoteMessage => {
      console.log('[Remote Message] ', JSON.stringify(remoteMessage));
      // Alert.alert('A new FCM message arrived!', JSON.stringify(remoteMessage));
    });
    return unsubscribe;
  }, []);

  return (...
```

ì•±ì„ ì‹¤í–‰ì‹œí‚¤ê³  tokenì„ í™•ì¸í•œë‹¤. ë³µì‚¬í•œ ë‹¤ìŒì— firebaseë¡œ ëŒì•„ì˜¨ë‹¤.

- ì²« ë²ˆì§¸ ìº í˜ì¸ ë§Œë“¤ê¸° ë˜ëŠ” ìƒˆ ìº í˜ì¸ì„ ëˆŒëŸ¬ ìº í˜ì¸ì„ ìƒì„±í•œë‹¤.

<img src='../attachment/231005/fcm_sendmessagetest01.PNG'>

<img src='../attachment/231005/fcm_sendmessagetest02.PNG'>

<img src='../attachment/231005/fcm_sendmessagetest03.PNG'>

- ì•Œë¦¼ì„ ì‘ì„±í•˜ê³  í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ì„ ëˆ„ë¥¸ë‹¤.

  ë‚˜ì˜¤ëŠ” íŒì—… ì°½ì— ì•„ê¹Œ ë³µì‚¬í–ˆë˜ ì—ë®¬ë ˆì´í„°ì˜ tokenì„ ë¶™ì—¬ë„£ê³  í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³¸ë‹¤.

<img src='../attachment/231005/fcm_sendmessagetest04.PNG'>

<img src='../attachment/231005/fcm_sendmessagetest05.PNG'>

í”„ë¡œì íŠ¸ ì½˜ì†”ì— ë¡œê·¸ê°€ ì˜ ì°íˆë©´ ëœë‹¤. ì•±ì´ ì‹¤í–‰ ì¤‘ì¼ ë•Œ, ë°±ê·¸ë¼ìš´ë“œì— ìˆì„ ë•Œ, êº¼ì ¸ ìˆì„ ë•Œ ëª¨ë‘ í…ŒìŠ¤íŠ¸ í•´ë³¸ë‹¤.

<img src='../attachment/231005/console01.png'>

---

ì´ì œ ì•Œë¦¼ì„ ì´ë ‡ê²Œ íŒŒì´ì–´ë² ì´ìŠ¤ì— ì ‘ì†ì—ì„œ ë³´ë‚´ì§€ ë§ê³  ì„œë²„ ì½”ë“œì—ì„œ ì§ì ‘ ë³´ë‚´ ë³´ì.

[íŒŒì´ì–´ë² ì´ìŠ¤ ê³µì‹ ë¬¸ì„œ1](https://firebase.google.com/docs/cloud-messaging/auth-server?hl=ko&authuser=1)ê³¼ [íŒŒì´ì–´ë² ì´ìŠ¤ ê³µì‹ ë¬¸ì„œ2](https://firebase.google.com/docs/cloud-messaging/send-message?hl=ko&authuser=1)ë¥¼ ì°¸ê³ í•œë‹¤.

<img src='../attachment/231005/serversend01.PNG'>

<img src='../attachment/231005/serversend02.PNG'>

<img src='../attachment/231005/serversend03.PNG'>

ì´ë¯¸ í‚¤ë¥¼ ìƒì„±í•´ì„œ ì´ë ‡ê²Œ ëœ¨ëŠ”ë° ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ í•˜ë‹¤ ë³´ë©´ ë‚˜ì˜¤ëŠ” ìƒˆ ë¹„ê³µê°œ í‚¤ ìƒì„±ì„ ëˆŒëŸ¬ json íŒŒì¼ì„ node.js ì„œë²„ í´ë”ì— ë‘”ë‹¤.

ìœ„ì¹˜ëŠ” í¬ê²Œ ìƒê´€ ì—†ìœ¼ë‚˜

**ê¹ƒí—ˆë¸Œì— ì˜¬ë¼ê°€ë©´ ì•ˆ ë˜ë¯€ë¡œ** .gitignoreì— í•´ë‹¹ json íŒŒì¼ì„ ì¶”ê°€í•œë‹¤.

<img src='../attachment/231005/serversend04.PNG'>

fcmê³¼ ê´€ë ¨ëœ í•¨ìˆ˜ê°€ ëª‡ ê°œ ìƒê¸¸ ê²ƒ ê°™ìœ¼ë¯€ë¡œ router, controller, modelë¡œ ë¶„ë¦¬í•œë‹¤.

1. í•¸ë“œí° ì•±(í´ë¼ì´ì–¸íŠ¸)ì—ì„œ ê³µì§€ ê¸€ì„ 'ì‘ì„± ì™„ë£Œ' ë²„íŠ¼ì„ ëˆ„ë¥¸ë‹¤.

2. Node.js ì„œë²„ì—ê²Œ `/api/post/create` ê²½ë¡œë¡œ ì‘ì„±ëœ ê³µì§€ê¸€ì˜ ë‚´ìš©ì„ bodyì— ë‹´ì•„ ìš”ì²­ì„ ë³´ë‚¸ë‹¤.

3. Node.js ì„œë²„ë¡œë¶€í„° createê°€ ì˜ ë˜ì—ˆë‹¤ëŠ” ì‘ë‹µì„ ë°›ìœ¼ë©´ `/api/fcm/push` ê²½ë¡œë¡œ ì‘ì„±ëœ ê³µì§€ê¸€ì˜ ë‚´ìš©ê³¼ ì‘ì„±ì ë³¸ì¸ í•¸ë“œí°ì˜ fcm tokenì„ bodyì— ë‹´ì•„ ìš”ì²­ì„ ë³´ë‚¸ë‹¤.

4. Node.js ì„œë²„ëŠ” DBì— ì €ì¥ëœ fcm tokenë“¤ì„ ì¡°íšŒí•˜ì—¬ ê°€ì ¸ì˜¨ë‹¤. ê·¸ ì¤‘ ì‘ì„±ìì˜ fcm tokenì„ ì œì™¸í•œ ë‹¤ë¥¸ ëª¨ë“  tokenë“¤(ì•±ì´ ì„¤ì¹˜ëœ ë‹¤ë¥¸ í•¸ë“œí°)ì— ì•Œë¦¼ì„ ë³´ë‚¸ë‹¤.

5. ì´ë ‡ê²Œ ë™ì‘í•˜ë ¤ë©´ ì•±ì´ ì„¤ì¹˜ë˜ê³  ì‹¤í–‰ë˜ëŠ” ì¦‰ì‹œ ê°ê°ì˜ í•¸ë“œí°ì´ ìì‹ ì˜ fcm tokenì„ ì„œë²„ì—ê²Œ ë³´ë‚´ì£¼ê³ , ì„œë²„ëŠ” ê° fcm tokenì„ DBì— ì €ì¥í•´ì•¼ í•œë‹¤.

6. ì•±ì„ ì„¤ì¹˜ í–ˆë‹¤ê°€ ì‚­ì œí•˜ëŠ” ê²½ìš°ì—ëŠ” fcm tokenì´ ê°±ì‹ ë˜ê³ , ì´ì „ fcm tokenì´ ë¬´ì˜ë¯¸í•´ì§€ë¯€ë¡œ ì“°ë ˆê¸° tokenì´ DBì— ìŒ“ì´ì§€ ì•Šë„ë¡ ì‚¬ìš©ìë“¤ì´ ì•±ì— ì ‘ì†í•  ë•Œë§ˆë‹¤ ì„œë²„ëŠ” ìš”ì²­ì„ ë°›ì•„ DBì˜ token ì •ë³´ë¥¼ updateí•˜ì—¬ ê´€ë¦¬í•  í•„ìš”ê°€ ìˆë‹¤.

==> push í•¨ìˆ˜ì™€ saveToken í•¨ìˆ˜ ë‘ ê°œë¡œ êµ¬ì„±í•œë‹¤.

```js
// main.js
...
const admin = require("firebase-admin");

const serviceAccount = require("./[ë‹¤ìš´ ë°›ê³  gitignoreì— ì¶”ê°€í•œ jsoníŒŒì¼ ê²½ë¡œ]");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});
...

const fcmRouter = require('./routers/fcmRouter.js');
app.use('/api/fcm', fcmRouter);

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

```js
// fcmRouter.js
const express = require('express');
const router = express.Router();
const fcmController = require('../controllers/fcmController.js');

router.post('/push', fcmController.push);
router.post('/saveToken', fcmController.saveToken);

module.exports = router;
```

```js
// fcmController.js
const fcmModel = require("../models/fcmModel");

const admin = require("firebase-admin");

module.exports = {
  push: async(req, res) => {
    const tokens = await fcmModel.getTokens();
    let tokenList = [];
    tokens.forEach((token) => {
      tokenList.push(token.token);
    });
    // ë‚˜ë¥¼ ì œì™¸í•œ ê¸°ê¸°ë“¤ì—ê²Œ ì•Œë¦¼
    const idx = tokenList.indexOf(req.body.myToken);
    if (idx > -1) tokenList.splice(idx, 1);
    
    if(tokenList.length) {
      const message = {
        notification: {
          title: req.body.title,
          body: req.body.body
        },
        tokens: tokenList
      };
    
      // Send a message to devices subscribed to the provided topic.
      admin.messaging().sendEachForMulticast(message)
        .then((response) => {
          // Response is a message ID string.
          console.log('Successfully sent message:', response);
        })
        .catch((error) => {
          console.log('Error sending message:', error);
        });
    } else {
      res.json({});
    }
  },
  saveToken: async (req, res) => {
    const token = req.body.token;
    console.log(token);
    await fcmModel.saveToken(token);
    res.json({result: true});
  }
}
```

```js
// fcmModel.js
const db = require('../config/db.js');

module.exports = {
  saveToken: async (token) => {
    // Tokenì´ ìˆìœ¼ë©´ update
    const searchToken = 'SELECT * FROM DeviceToken WHERE token=?;';
    const tokenHere = await db.query(searchToken, [token]);
    if(tokenHere[0].length) {
      const updateToken = 'UPDATE DeviceToken SET updated_at=NOW() WHERE token=?;';
      const result = await db.query(updateToken, [token]);
      console.log(result);
      return result[0];
    }
    const query = 'INSERT INTO DeviceToken(token) VALUES(?);';
    const result = await db.query(query, [token]);
    console.log(result);

    return result[0];
  },
  getTokens: async () => {
    const query = 'SELECT token FROM DeviceToken;';
    const result = await db.query(query);

    return result[0];
  }
}
```

DeviceToken í…Œì´ë¸”ì€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±ë˜ì–´ ìˆë‹¤.

<img src='../attachment/231005/tokendb01.PNG'>

ì§€ê¸ˆ ìƒê°í•´ ë³´ë‹ˆ ìš°ë¦¬ëŠ” ê¸°ìˆ˜ ë³„ë¡œ ì•Œë¦¼ì„ ë³´ë‚´ëŠ” ê¸°ëŠ¥ì´ í•„ìš”í•´ì„œ tokenê³¼ í•¨ê»˜ ê¸°ìˆ˜ ì •ë³´ë¥¼ ì €ì¥í•´ì•¼ í•  ê²ƒ ê°™ë‹¤.

getTokens í•¨ìˆ˜ì—ì„œ WHERE level=? êµ¬ë¬¸ë§Œ ì¶”ê°€í•˜ë©´ ì ì ˆí•œ ì½”ë“œê°€ ë  ë“¯ í•„ìš”í•œ ë³€ìˆ˜ ë„˜ê²¨ ì£¼ê³ 

ì´ì œ ë‹¤ì‹œ RN í´ë¼ì´ì–¸íŠ¸ ì½”ë“œë¡œ ë„˜ì–´ì™€ì„œ ì´ APIë¥¼ í˜¸ì¶œí•˜ëŠ” fetch ë¡œì§ì„ ì‘ì„±í•´ì•¼ í•œë‹¤.

ì•Œë¦¼ê³¼ ê¸°ê¸° í† í°ì„ ì„œë²„ì— ì „ì†¡í•˜ëŠ” fetch ìš”ì²­ì€ ìì£¼ ì‚¬ìš©ë  ê²ƒ ê°™ìœ¼ë¯€ë¡œ utils.jsì— ë”°ë¡œ ë¶„ë¦¬í•´ ë‘”ë‹¤.

pushNotiì—ëŠ” ë³´ë‚¸ ì‚¬ëŒì—ê²ŒëŠ” ì•Œë¦¼ì´ ì „ì†¡ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¢‹ê² ìœ¼ë¯€ë¡œ ë³¸ì¸ì˜ tokenì„ ê°€ì ¸ì™€ì„œ í•¨ê»˜ ì„œë²„ì— ë³´ë‚´ì¤€ë‹¤.

fetchPost í•¨ìˆ˜ ë˜í•œ ìì£¼ ì‚¬ìš©í•´ì„œ utils.jsì— ë§Œë“¤ì–´ë‘” í•¨ìˆ˜ì´ë‹¤. fetchPost í•¨ìˆ˜ëŠ” ì•ˆì—ì„œ fetchë¥¼ í•œë‹¤.

<img src='../attachment/231005/fetchnoti03.PNG'>

<img src='../attachment/231005/fetchnoti04.PNG'>

í•¨ìˆ˜ë¥¼ ë²„íŠ¼ê³¼ ì—°ê²°í•œë‹¤.

ê³µì§€ê¸€ 'ì‘ì„± ì™„ë£Œ' ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ì— pushNoti í•¨ìˆ˜ë¥¼ ì—°ê²°í•œë‹¤.

<img src='../attachment/231005/fetchnoti01.PNG'>

<img src='../attachment/231005/fetchnoti05.PNG'>

ë§ˆì°¬ê°€ì§€ë¡œ ê¸€ ì‚­ì œ, ê¸€ ìˆ˜ì • ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë„ pushNoti í•¨ìˆ˜ë¥¼ ì—°ê²°í•œë‹¤.

ë˜í•œ ì–´í”Œì´ ì‹¤í–‰ë  ë•Œ ì„œë²„ì— ìì‹ ì˜ fcm tokenì„ ì „ë‹¬í•´ ì£¼ì–´ì•¼ í•˜ë¯€ë¡œ App.js íŒŒì¼ì—ì„œ saveToken í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œì¼œ ì¤€ë‹¤.

<img src='../attachment/231005/fetchnoti06.png'>

ì™„ë£Œ!

## ğŸ’¦ ë°œìƒí•œ ì–´ë ¤ì›€

<img src='../attachment/231005/appcrash.png'>

ìê¾¸ êº¼ì§ ;;;

Android Manifestì—ì„œ ë‹¤ìŒ ì½”ë“œë¥¼ ì§€ìš°ë‹ˆ í•´ê²°

<img src='../attachment/231005/manifest.PNG'>

ê³µì‹ ë¬¸ì„œì— ìˆë˜ ê±´ë° ... RNì´ë¼ì„œ ì¢€ ë‹¤ë¥¸ ê±´ì§€ ê·¼ë° ë˜ Myê°€ ì•ì— ë¶™ì€ ê±¸ ë³´ë‹ˆ ë‚´ê°€ ë­”ê°ˆ ë” ì„¤ì •í•´ ì£¼ì–´ì•¼ í•˜ëŠ” ê±´ê°€?

ì–´ë–»ê²Œ ì•Œê²Œ ë˜ì—ˆëƒí•˜ë©´

ë¡œê·¸ë„ ì—†ì´ ì•±ì´ êº¼ì ¸ ë²„ë¦¬ë‹ˆê¹Œ ì›ì¸ì„ í•œì°¸ ëª» ì°¾ë‹¤ê°€

**ìê³  ì¼ì–´ë‚˜ì„œ** ë‹¤ì‹œ ì‹œë„

Android Studioë¥¼ ì¼œê³  rní”„ë¡œì íŠ¸ ì•ˆì˜ android í´ë”ë¥¼ ì—´ì–´ ì¤Œ

ì—¬ê¸°ì„œ build ì§„í–‰

Android Studio ë°”ë‹¥ ìª½ì— log cat ì´ë¼ê³  ìˆëŠ”ë° ê·¸ ë¡œê·¸ë¥¼ ë³µì‚¬í•´ì„œ ì§€í”¼í‹°ì—ê²Œ ë¬¸ì˜..

```
FATAL EXCEPTION: main
                                                                                                    Process: com.client, PID: 29651
                                                                                                    java.lang.RuntimeException: Unable to create service com.client.java.MyFirebaseMessagingService: java.lang.ClassNotFoundException: Didn't find class "com.client.java.MyFirebaseMessagingService" on path: DexPathList[[zip file "/data/app/~~ANrpfIjjkYJpGQEzn1K9ZA==/com.client-TisyzPYUYJnf2C2lvt_2JQ==/base.apk"],nativeLibraryDirectories=[/data/app/~~ANrpfIjjkYJpGQEzn1K9ZA==/com.client-TisyzPYUYJnf2C2lvt_2JQ==/lib/x86_64, /data/app/~~ANrpfIjjkYJpGQEzn1K9ZA==/com.client-TisyzPYUYJnf2C2lvt_2JQ==/base.apk!/lib/x86_64, /system/lib64, /system_ext/lib64]]
                                                                                                    	at android.app.ActivityThread.handleCreateService(ActivityThread.java:4498)
                                                                                                    	at android.app.ActivityThread.-$$Nest$mhandleCreateService(Unknown Source:0)
                                                                                                    	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:2161)
                                                                                                    	at android.os.Handler.dispatchMessage(Handler.java:106)
                                                                                                    	at android.os.Looper.loopOnce(Looper.java:201)
                                                                                                    	at android.os.Looper.loop(Looper.java:288)
                                                                                                    	at android.app.ActivityThread.main(ActivityThread.java:7872)
                                                                                                    	at java.lang.reflect.Method.invoke(Native Method)
                                                                                                    	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:548)
                                                                                                    	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:936)
                                                                                                    Caused by: java.lang.ClassNotFoundException: Didn't find class "com.client.java.MyFirebaseMessagingService" on path: DexPathList[[zip file "/data/app/~~ANrpfIjjkYJpGQEzn1K9ZA==/com.client-TisyzPYUYJnf2C2lvt_2JQ==/base.apk"],nativeLibraryDirectories=[/data/app/~~ANrpfIjjkYJpGQEzn1K9ZA==/com.client-TisyzPYUYJnf2C2lvt_2JQ==/lib/x86_64, /data/app/~~ANrpfIjjkYJpGQEzn1K9ZA==/com.client-TisyzPYUYJnf2C2lvt_2JQ==/base.apk!/lib/x86_64, /system/lib64, /system_ext/lib64]]
                                                                                                    	at dalvik.system.BaseDexClassLoader.findClass(BaseDexClassLoader.java:259)
                                                                                                    	at java.lang.ClassLoader.loadClass(ClassLoader.java:379)
                                                                                                    	at java.lang.ClassLoader.loadClass(ClassLoader.java:312)
                                                                                                    	at android.app.AppComponentFactory.instantiateService(AppComponentFactory.java:129)
                                                                                                    	at androidx.core.app.CoreComponentFactory.instantiateService(CoreComponentFactory.java:75)
                                                                                                    	at android.app.ActivityThread.handleCreateService(ActivityThread.java:4467)
                                                                                                    	at android.app.ActivityThread.-$$Nest$mhandleCreateService(Unknown Source:0) 
                                                                                                    	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:2161) 
                                                                                                    	at android.os.Handler.dispatchMessage(Handler.java:106) 
                                                                                                    	at android.os.Looper.loopOnce(Looper.java:201) 
                                                                                                    	at android.os.Looper.loop(Looper.java:288) 
                                                                                                    	at android.app.ActivityThread.main(ActivityThread.java:7872) 
                                                                                                    	at java.lang.reflect.Method.invoke(Native Method) 
                                                                                                    	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:548) 
                                                                                                    	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:936)
```

```
ì£¼ì–´ì§„ ë¡œê·¸ë¥¼ ë³´ë©´ ì•±ì´ ì‹¤í–‰ ì¤‘ì— MyFirebaseMessagingService í´ë˜ìŠ¤ë¥¼ ì°¾ì§€ ëª»í•´ ë°œìƒí•˜ëŠ” ClassNotFoundException ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ ì˜¤ë¥˜ëŠ” Firebase Cloud Messagingì˜ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤.

ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

í´ë˜ìŠ¤ ì´ë¦„ í™•ì¸: MyFirebaseMessagingService í´ë˜ìŠ¤ì˜ ì´ë¦„ì´ ì •í™•í•˜ê²Œ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. ëŒ€ì†Œë¬¸ìì™€ íŒ¨í‚¤ì§€ ì´ë¦„ì„ ì •í™•í•˜ê²Œ ì¼ì¹˜ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.

íŒ¨í‚¤ì§€ ì´ë¦„ í™•ì¸: MyFirebaseMessagingService í´ë˜ìŠ¤ì˜ íŒ¨í‚¤ì§€ ì´ë¦„ì´ ì •í™•í•˜ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. Manifest íŒŒì¼ê³¼ Java íŒŒì¼ì—ì„œ íŒ¨í‚¤ì§€ ì´ë¦„ì´ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

ë¹Œë“œ ë° Clean: Android Studio ë˜ëŠ” Gradleì—ì„œ í”„ë¡œì íŠ¸ë¥¼ ë‹¤ì‹œ ë¹Œë“œí•˜ê³ , "Clean Project" ì‘ì—…ì„ ìˆ˜í–‰í•˜ì—¬ ë¹Œë“œ ìºì‹œë¥¼ ì§€ìš°ê³  ë‹¤ì‹œ ë¹Œë“œí•˜ì„¸ìš”.

ë¶ˆí•„ìš”í•œ íŒŒì¼ ì‚­ì œ: ë¶ˆí•„ìš”í•œ í´ë˜ìŠ¤ íŒŒì¼ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ íŒŒì¼ì´ í”„ë¡œì íŠ¸ ë‚´ì— ë‚¨ì•„ìˆì§€ ì•ŠëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. ì¢…ì¢… ì´ëŸ¬í•œ íŒŒì¼ì´ ë¬¸ì œì˜ ì›ì¸ì´ ë©ë‹ˆë‹¤.

ë©€í‹° ëª¨ë“ˆ êµ¬ì„± í™•ì¸: í”„ë¡œì íŠ¸ê°€ ë©€í‹° ëª¨ë“ˆì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ëª¨ë“ˆ ê°„ì˜ ì˜ì¡´ì„±ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

ì•± íŒ¨í‚¤ì§€ ì´ë¦„ í™•ì¸: AndroidManifest.xml íŒŒì¼ì—ì„œ ì•±ì˜ íŒ¨í‚¤ì§€ ì´ë¦„ì´ ì •í™•í•˜ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

Gradle ì˜ì¡´ì„± í™•ì¸: Gradle íŒŒì¼ì—ì„œ Firebase ê´€ë ¨ ì˜ì¡´ì„±ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ë²„ì „ì„ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.

Firebase ì„œë¹„ìŠ¤ ë“±ë¡: Firebase Consoleì—ì„œ ì•±ì˜ ì„œë¹„ìŠ¤ì™€ ì¸ì¦ ì„¤ì •ì´ ì •í™•í•˜ê²Œ êµ¬ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

Android Studio ì—…ë°ì´íŠ¸: Android Studioë¥¼ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ê³ , Gradle í”ŒëŸ¬ê·¸ì¸ê³¼ ë¹Œë“œ ë„êµ¬ë„ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.

í”„ë¡œì íŠ¸ ì¬êµ¬ì„±: ê²½ìš°ì— ë”°ë¼ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ìƒì„±í•˜ê±°ë‚˜, ì•ˆë“œë¡œì´ë“œ ìŠ¤íŠœë””ì˜¤ ì„¤ì • í´ë”ë¥¼ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ì‹œì‘í•˜ëŠ” ê²ƒì´ ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìœ„ì˜ ë‹¨ê³„ë¥¼ ë”°ë¼ ì‹œë„í•˜ë©´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  ë¬¸ì œê°€ í•´ê²°ë˜ì§€ ì•Šìœ¼ë©´ ì¶”ê°€ì ì¸ ì •ë³´ë‚˜ ì½”ë“œ ìŠ¤ë‹ˆí«ì„ ì œê³µí•˜ë©´ ë” êµ¬ì²´ì ì¸ ì§€ì›ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```

ì§€ìš°ë‹ˆê¹Œ ë˜ë”ë¼..

## ğŸ“š Reference

â¬ ìµœê³  ë„ì›€ ë§ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!!! ê°ì‚¬í•©ë‹ˆë‹¤

https://velog.io/@kwonh/ReactNative-%ED%91%B8%EC%89%AC%EC%95%8C%EB%A6%BC-%EA%B3%B5%EC%8B%9D%EB%AC%B8%EC%84%9C-%EB%94%B0%EB%9D%BC%ED%95%98%EA%B8%B0-Firebase-Cloud-Messaging-react-native-firebase-notification-%EC%95%88%EB%93%9C%EB%A1%9C%EC%9D%B4%EB%93%9C#cloud-messaging-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0

https://velog.io/@mywonhyuni/%EA%B8%B0%EB%8A%A5%EA%B5%AC%ED%98%84RN-firebase%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-Push-notification-%EB%A7%8C%EB%93%A4%EA%B8%B0#1-android--app--buildgradle-%EC%B6%94%EA%B0%80-%ED%95%AD%EB%AA%A9

https://velog.io/@ddowoo/react-native-%ED%91%B8%EC%8B%9C%EC%95%8C%EB%A6%BC-%EA%B5%AC%ED%98%84-firebase-notifee

https://falsy.me/react-native%EC%97%90%EC%84%9C-fcm%EC%9D%84-%ED%86%B5%ED%95%9C-%EC%95%8C%EB%A6%BC-%EC%88%98%EC%8B%A0%ED%95%98%EA%B8%B0android/

https://honeystorage.tistory.com/255

https://honeystorage.tistory.com/306